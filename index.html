<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BEV Trajectories · Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --maxw: 1100px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b101b; color: #e9eef2; }
    header { max-width: var(--maxw); margin: 18px auto 8px; padding: 0 10px; display: grid; grid-template-columns: 1fr auto; align-items: start; gap: 12px; }
    header h1 { font-size: 22px; margin: 0; }
    .links { text-align: right; font-size: 12px; line-height: 1.4; }
    .links a { color: #9fb3d1; text-decoration: none; }
    .links a:hover { text-decoration: underline; }

    .tabs{max-width:var(--maxw);margin:8px auto 0;padding:0 10px;display:flex;gap:10px;flex-wrap:wrap}
    .tablink{padding:8px 12px;border:1px solid #1f2a44;border-radius:10px;background:#101a33;color:#e9eef2;text-decoration:none}
    .tablink.active{background:#e9eef2;color:#0b0c10}
    .tab{display:none}
    .tab.active{display:block}

    .page { max-width: var(--maxw); margin: 12px auto; padding: 0 10px; }
    .card { max-width: var(--maxw); margin: 12px auto; padding: 16px; border: 1px dashed #2a3654; border-radius: 12px; background:#0f1525 }
    .muted { color:#9fb3d1; font-size: 13px; }

    #tab-thresholds table { width:100%; border-collapse: collapse; }
    #tab-thresholds th, #tab-thresholds td { padding: 10px 12px; border-bottom: 1px solid #1f2a44; }
    #tab-thresholds thead th { font-weight: 750; letter-spacing: 0.02em; }
    #tab-thresholds th.sortable { cursor: pointer; position: relative; user-select: none; }
    #tab-thresholds th.sortable::after { content: " ↕"; opacity: 0.6; font-size: 0.9em; }
    #tab-thresholds th.sortable.asc::after { content: " ↑"; }
    #tab-thresholds th.sortable.desc::after { content: " ↓"; }
    #tab-thresholds td.num, #tab-thresholds th.num { width: 56px; text-align: right; color: #9fb3d1; }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-bottom:12px; }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#9fb3d1}
    input[type="number"], select { background:#0e1a34; border:1px solid #1f2a44; color:#e9eef2; padding:8px 10px; border-radius:8px; }
    button { background:#e9eef2;color:#0b0c10;border:0;padding:10px 12px;border-radius:10px;cursor:pointer }
    .btn-ghost { background:#0e1a34; color:#e9eef2; border:1px solid #1f2a44; }
    .help { font-size:13px; color:#b4c2d8; margin: 4px 0 0; }
    .spacer { flex: 1 1 auto; }
    .error { color:#ffb4b4; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>BEV Trajectories · Gallery</h1>
    <div class="links">
      <a href="https://x.com/leRaffl" target="_blank" rel="noopener">x.com/leRaffl</a><br />
      <a href="https://bsky.app/profile/leraffl.bsky.social" target="_blank" rel="noopener">bsky.app/profile/leraffl.bsky.social</a>
    </div>
  </header>

  <nav class="tabs">
    <a href="#gallery" class="tablink active">Gallery</a>
    <a href="#thresholds" class="tablink">Thresholds</a>
    <a href="#durations" class="tablink">Durations</a>
  </nav>

  <section id="tab-gallery" class="tab active">
    <div class="page">
      <p class="muted">This page adds an interactive thresholds table. Switch tabs to see it in action.</p>
    </div>
  </section>

  <section id="tab-thresholds" class="tab">
    <div class="page">
      <h2 style="margin:6px 0 12px">Thresholds (years)</h2>
      <div class="toolbar">
        <div class="field">
          <label for="customPct">Custom threshold (%)</label>
          <input id="customPct" type="number" min="1" max="99" step="1" value="90" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="applyBtn">Recalculate</button>
        </div>
        <div class="field" style="min-width:320px">
          <label for="variantMulti">Variant filter (multi-select)</label>
          <select id="variantMulti" multiple size="6" aria-label="Variant multi-select"></select>
        </div>
        <div class="spacer"></div>
        <div class="field" style="min-width:240px">
          <label>Export current table</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="exportCsv" class="btn-ghost">CSV (comma)</button>
            <button id="exportCsvEU" class="btn-ghost">CSV (semicolon)</button>
            <button id="copyCsv" class="btn-ghost">Copy CSV</button>
          </div>
        </div>
      </div>
      <p class="help">Choose a custom threshold, then sort the table. Use the variant filter to include multiple categories. Default selects “Whole” (the total market). Exports reflect your current filter and custom setting.</p>
    </div>
    <div id="thresholdsMount" class="card">Loading <code>params.csv</code> and computing 20% / 50% / 80% + Custom in the browser.</div>
  </section>

  <section id="tab-durations" class="tab">
    <div class="page"><h2 style="margin:6px 0 12px">Durations</h2></div>
    <div id="durationsMount" class="card">Placeholder.</div>
  </section>

  <script>
    // Fatal error helper: show errors in the UI so "nothing" isn't a thing
    function showFatal(msg){
      const m = document.getElementById('thresholdsMount');
      if(m) m.innerHTML = '<div class="error">Error: ' + String(msg) + '</div>';
      console.error(msg);
    }

    // ---------- Tab switching ----------
    function activateTabByHash(){
      const hash = location.hash || '#gallery';
      const id = hash.replace('#','');
      const tabs = document.querySelectorAll('.tab');
      const links = document.querySelectorAll('.tablink');
      tabs.forEach(el => { el.classList.remove('active'); el.setAttribute('hidden',''); });
      links.forEach(a => a.classList.remove('active'));
      const tab = document.getElementById('tab-' + id) || document.getElementById('tab-gallery');
      const link = document.querySelector('.tablink[href="#' + id + '"]') || document.querySelector('.tablink[href="#gallery"]');
      if (tab) { tab.classList.add('active'); tab.removeAttribute('hidden'); }
      if (link) link.classList.add('active');
    }
    window.addEventListener('hashchange', activateTabByHash);
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tablink').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const href = a.getAttribute('href') || '#gallery';
          history.replaceState(null, '', href);
          activateTabByHash();
        });
      });
      activateTabByHash();
    });

    // ---------- CSV Parser ----------
    function parseCSV(text) {
      const raw = (text || '').trim();
      if (!raw) return [];
      const first = raw.split(/\r?\n/)[0] || '';
      const delimiter = (first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length ? ';' : ',';
      const lines = raw.split(/\r?\n/);
      const header = (lines.shift() || '').split(delimiter).map(h => h.replace(/^\uFEFF?/,'').trim());
      return lines.filter(Boolean).map(line => {
        const cols = line.split(new RegExp(`${delimiter}(?=(?:[^"]*"[^"]*")*[^"]*$)`));
        const o = {};
        header.forEach((h,i)=> o[h] = (cols[i]||'').replace(/^\"|\"$/g,'').trim());
        return o;
      });
    }

    // ---------- Helpers ----------
    const normNumber = x => { const s = String(x||"").trim().replace(',','.'); const n = Number(s); return isFinite(n)?n:NaN; };
    function isoDateToYearFrac(iso){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(String(iso||"")))return NaN;
      const d=new Date(iso+"T00:00:00Z"); if(isNaN(d))return NaN;
      const y0=Date.UTC(d.getUTCFullYear(),0,1), y1=Date.UTC(d.getUTCFullYear()+1,0,1);
      return d.getUTCFullYear()+((d.getTime()-y0)/(y1-y0));
    }
    function toYYYYMM(s){
      if(!s) return '';
      if(/^\d{4}-\d{2}$/.test(s)) return s;
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s.slice(0,7);
      return '';
    }

    // Canonicalize variant base
    function normalizeBase(s){
      const k = String(s||'').trim().toLowerCase();
      if(!k) return '';
      if(['all','total','overall','whole','total market','market total','entire','entire market','total vehicles','fleet total'].includes(k)) return 'whole';
      return k;
    }
    function displayLabelFromBase(base){
      const n = normalizeBase(base);
      if(n==='whole') return 'Whole';
      return String(base||'').replace(/\s+/g,' ').trim().replace(/(^|\s)\S/g, c => c.toUpperCase());
    }

    // Year-index -> ISO date, with absolute-year guard
    function yearsIndexToDate(xYears, baseline_date, baseline_year){
      if(!isFinite(xYears)) return "";
      // If it looks like an absolute year, don't add a baseline again
      if (xYears >= 1800 && xYears < 3000) {
        const y = Math.floor(xYears);
        const frac = xYears - y;
        const start = new Date(Date.UTC(y, 0, 1));
        const end   = new Date(Date.UTC(y + 1, 0, 1));
        const t = start.getTime() + frac * (end.getTime() - start.getTime());
        return new Date(t).toISOString().slice(0,10);
      }
      let base;
      if(baseline_date && /^\d{4}-\d{2}-\d{2}$/.test(baseline_date)){
        base=new Date(baseline_date+"T00:00:00Z");
      }else if(isFinite(normNumber(baseline_year))){
        base=new Date(Math.round(normNumber(baseline_year))+"-01-01T00:00:00Z");
      }else{return "";}
      if(isNaN(base))return "";
      const years=Math.floor(xYears), frac=xYears-years;
      const start=new Date(Date.UTC(base.getUTCFullYear()+years, base.getUTCMonth(), base.getUTCDate()));
      const end=new Date(Date.UTC(start.getUTCFullYear()+1,start.getUTCMonth(),start.getUTCDate()));
      const t=start.getTime()+frac*(end.getTime()-start.getTime());
      return new Date(t).toISOString().slice(0,10);
    }

    function inv_x_years(y,v1,v2,t0){
      const v1n=normNumber(v1), v2n=normNumber(v2), t0n=normNumber(t0);
      if(!(y>0&&y<1))return{x:NaN,why:"y∉(0,1)"};
      if(!isFinite(v1n)||!isFinite(v2n)||!isFinite(t0n))return{x:NaN,why:"v1/v2/t0 not numeric"};
      if(v2n===0)return{x:NaN,why:"v2=0"};
      if(v1n>=0)return{x:NaN,why:"v1 must be < 0"};
      const num=Math.log(1-y)/v1n; if(!(num>0))return{x:NaN,why:"ln(1-y)/v1 ≤ 0"};
      return{x:(t0n-1)+Math.pow(num,1/v2n),why:null};
    }

    function getT0Years(r){
      const baseDate=r.baseline_date||"", baseYear=normNumber(r.baseline_year), t0raw=(r.t0||"").trim();
      let t0n=normNumber(t0raw);
      if(isFinite(t0n)&&t0n>=1800&&(isFinite(baseYear)||/^\d{4}-\d{2}-\d{2}$/.test(baseDate))){
        const by=isFinite(baseYear)?Math.round(baseYear):(new Date(baseDate+"T00:00:00Z")).getUTCFullYear();
        return (t0n-by)+1;
      }
      if(/^\d{4}-\d{2}-\d{2}$/.test(t0raw)){
        const t0yf=isoDateToYearFrac(t0raw);
        const by=isFinite(baseYear)?baseYear:isoDateToYearFrac(baseDate);
        if(isFinite(by)&&isFinite(t0yf))return (t0yf-by)+1;
      }
      return t0n;
    }

    function getDataPer(r){
      const candidates=[
        r.data_per, r.latest_month, r.last_month, r.month_latest, r.data_month,
        r.latest_date, r.last_date, r.obs_last, r.data_asof
      ].map(x=>String(x||'').trim()).filter(Boolean);
      for(const c of candidates){
        const m = toYYYYMM(c);
        if(m) return m;
      }
      return '';
    }

    function extractVariantParts(variant){
      const v=String(variant||'');
      const base = v.replace(/\s*\([^)]*\)\s*$/, '').trim();
      const paren = (v.match(/\(([^)]*)\)/)||[])[1]||'';
      const attrs = new Set();
      paren.split(/[,;|/]/).map(s=>s.trim()).filter(Boolean).forEach(x=>attrs.add(x));
      return { base, attrs: Array.from(attrs) };
    }

    document.addEventListener("DOMContentLoaded",()=>{
      const urls=["./params.csv","params.csv"];
      (function next(i){ if(i>=urls.length){ showFatal("Could not load params.csv."); return; }
        fetch(urls[i],{cache:"no-store"})
          .then(r=>r.ok?r.text():Promise.reject("HTTP " + r.status))
          .then(txt=>renderThresholds(txt))
          .catch(err=>next(i+1));
      })(0);
    });

    function renderThresholds(csvText){
      try {
        const rows=parseCSV(csvText);
        const mount=document.getElementById('thresholdsMount');
        if(!rows.length){ showFatal("params.csv contains no data rows."); return; }

        // Build variant base list and collapse synonyms
        const rawBases = new Set();
        rows.forEach(r=>{ const parts=extractVariantParts(r.variant||''); if(parts.base) rawBases.add(parts.base); });

        const sel = document.getElementById('variantMulti');
        sel.innerHTML = '';
        const bases = [...rawBases].sort((a,b)=>a.localeCompare(b));
        const seenCanonical = new Set();
        const optionMap = [];
        bases.forEach(base => {
          const canonical = normalizeBase(base);
          const label = displayLabelFromBase(base);
          if(!canonical) return;
          if(seenCanonical.has(canonical)) return;
          seenCanonical.add(canonical);
          optionMap.push({canonical, label});
        });
        optionMap.sort((a,b)=> (a.canonical==='whole'? -1 : b.canonical==='whole'? 1 : a.label.localeCompare(b.label)) );
        optionMap.forEach(({canonical,label}) => {
          const opt = document.createElement('option');
          opt.value = canonical;
          opt.textContent = label;
          if (canonical === 'whole') opt.selected = true;
          sel.appendChild(opt);
        });
        sel.addEventListener('change', renderTable);

        const customPctEl = document.getElementById('customPct');
        document.getElementById('applyBtn').addEventListener('click', ()=> renderTable());

        let sortKey = 'val80', sortAsc = true;

        function computeData(){
          const pct = Math.max(1, Math.min(99, Number(customPctEl.value)||90));
          const y = pct/100;
          return rows.map(r=>{
            const v1=normNumber(r.v1), v2=normNumber(r.v2), t0=getT0Years(r), baseDate=r.baseline_date||"", baseYear=normNumber(r.baseline_year);
            const r20=inv_x_years(0.2,v1,v2,t0), r50=inv_x_years(0.5,v1,v2,t0), r80=inv_x_years(0.8,v1,v2,t0), rc=inv_x_years(y,v1,v2,t0);
            const fmt=res=>!res||!isFinite(res.x)?{text:"—",val:Infinity,title:res?.why||"no solution"}:{
              text: (yearsIndexToDate(res.x,baseDate,baseYear) || res.x.toFixed(2)),
              val: Date.parse(yearsIndexToDate(res.x,baseDate,baseYear)) || parseFloat(res.x),
              title:""
            };
            const f20=fmt(r20), f50=fmt(r50), f80=fmt(r80), fc=fmt(rc);
            const parts = extractVariantParts(r.variant||'');
            return {
              country: r.country||'',
              variantBaseCanonical: normalizeBase(parts.base||''),
              variant: r.variant||'',
              val20: f20.text, _v20: f20.val,
              val50: f50.text, _v50: f50.val,
              val80: f80.text, _v80: f80.val,
              custom: fc.text, _vc: fc.val,
              data_per: getDataPer(r)
            };
          });
        }

        function getSelectedCanonicals(){
          return Array.from(sel.selectedOptions || []).map(o => o.value);
        }
        function applyVariantFilter(arr){
          const selected = new Set(getSelectedCanonicals());
          if(selected.size===0) return [];
          return arr.filter(r => selected.has(r.variantBaseCanonical||''));
        }

        let data = computeData();

        function isoOrValForSort(row, key){
          if(key==='_v20' || key==='_v50' || key==='_v80' || key==='__vc') return row[key] || Infinity;
          if(key==='val20') return row._v20 || Infinity;
          if(key==='val50') return row._v50 || Infinity;
          if(key==='val80') return row._v80 || Infinity;
          if(key==='custom') return row._vc || Infinity;
          if(key==='data_per') return Date.parse((row.data_per||'')+'-01') || row.data_per || '';
          return row[key];
        }

        function doSort(){ if(!sortKey) return; data.sort((a,b)=>{
          const va=isoOrValForSort(a,sortKey), vb=isoOrValForSort(b,sortKey);
          return va<vb?(sortAsc?-1:1):va>vb?(sortAsc?1:-1):0;
        }); }

        function headerHTML(){
          return `<thead><tr>
            <th class="num">#</th>
            <th class="sortable" data-key="country">Country</th>
            <th class="sortable" data-key="variant">Variant</th>
            <th class="sortable" data-key="val20">20%</th>
            <th class="sortable" data-key="val50">50%</th>
            <th class="sortable" data-key="val80">80%</th>
            <th class="sortable" data-key="custom">Custom</th>
            <th class="sortable" data-key="data_per">Data per</th>
          </tr></thead>`;
        }

        function bodyHTML(){
          const filtered = applyVariantFilter(data);
          return `<tbody>${filtered.map((r,i)=>`<tr>
            <td class="num">${i+1}</td>
            <td>${r.country}</td>
            <td>${r.variant}</td>
            <td>${r.val20}</td>
            <td>${r.val50}</td>
            <td>${r.val80}</td>
            <td>${r.custom}</td>
            <td>${r.data_per||''}</td>
          </tr>`).join('')}</tbody>`;
        }

        function renderTable(){
          try{
            data = computeData();
            doSort();
            mount.innerHTML = `<table>${headerHTML()}${bodyHTML()}</table>`;
            mount.querySelectorAll('th.sortable').forEach(th=>{
              th.classList.remove('asc','desc');
              if(th.dataset.key===sortKey) th.classList.add(sortAsc?'asc':'desc');
              th.onclick=()=>{ const key=th.dataset.key; if(sortKey===key) sortAsc=!sortAsc; else { sortKey=key; sortAsc=true; } renderTable(); };
            });
          }catch(e){ showFatal(e && e.message ? e.message : e); }
        }

        // ------- EXPORTS -------
        function escapeCsvCell(s, delimiter){
          const needsQuote = typeof s === 'string' && (s.includes(delimiter) || s.includes('"') || s.includes('\n'));
          let out = String(s ?? '');
          out = out.replace(/"/g, '""');
          return needsQuote ? `"${out}"` : out;
        }
        function buildExportRows(){
          const filtered = applyVariantFilter(data).slice();
          return filtered.map((r,i)=>({
            rank: i+1,
            country: r.country,
            variant: r.variant,
            y20: r.val20,
            y50: r.val50,
            y80: r.val80,
            ycustom: r.custom,
            data_per: r.data_per || ''
          }));
        }
        function download(filename, text, mime){
          const blob = new Blob([text], {type: mime || 'text/plain;charset=utf-8'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename;
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        }
        function rowsToCSV(rows, delimiter){
          const d = delimiter || ',';
          const header = ['#','Country','Variant','20%','50%','80%','Custom','Data per'];
          const head = header.map(h => escapeCsvCell(h, d)).join(d);
          const body = rows.map(r => [r.rank,r.country,r.variant,r.y20,r.y50,r.y80,r.ycustom,r.data_per].map(v=>escapeCsvCell(v,d)).join(d)).join('\n');
          return head + '\n' + body + '\n';
        }
        function copyToClipboard(text){
          if(navigator.clipboard && window.isSecureContext){
            return navigator.clipboard.writeText(text);
          }
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove();
          return Promise.resolve();
        }

        document.getElementById('exportCsv').addEventListener('click', ()=>{
          const rows = buildExportRows();
          const csv = rowsToCSV(rows, ',');
          download('bev_thresholds.csv', csv, 'text/csv;charset=utf-8');
        });
        document.getElementById('exportCsvEU').addEventListener('click', ()=>{
          const rows = buildExportRows();
          const csv = rowsToCSV(rows, ';');
          download('bev_thresholds_eu.csv', csv, 'text/csv;charset=utf-8');
        });
        document.getElementById('copyCsv').addEventListener('click', ()=>{
          const rows = buildExportRows();
          const csv = rowsToCSV(rows, ',');
          copyToClipboard(csv).then(()=>{
            const btn = document.getElementById('copyCsv');
            const old = btn.textContent;
            btn.textContent = 'Copied ✓';
            setTimeout(()=>btn.textContent = old, 1200);
          });
        });

        renderTable();
      } catch(e){
        showFatal(e && e.message ? e.message : e);
      }
    }
  </script>
</body>
</html>
