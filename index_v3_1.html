<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BEV Trajectories • Gallery</title>
<style>
:root{--maxw:1280px;--gap:18px}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0b0c10;color:#e9eef2}
header{position:sticky;top:0;z-index:5;background:#0f1117cc;backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid #1c2333}
header .bar{max-width:var(--maxw);margin:0 auto;padding:12px 10px;display:flex;align-items:center;gap:12px}
header h1{margin:0;font-size:20px;font-weight:700}

/* Layout */
.page{max-width:var(--maxw);margin:14px auto;display:grid;grid-template-columns:260px 1fr;gap:18px;padding:0 10px}
@media (max-width:880px){.page{grid-template-columns:1fr}}

/* Sidebar */
.side{background:#0f1525;border:1px solid #1f2a44;border-radius:14px;padding:12px;position:sticky;top:64px;height:fit-content;z-index:10}
.side h2{margin:0 0 8px;font-size:14px;opacity:.9}
select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #273145;background:#0f1525;color:#e9eef2}
select{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23e9eef2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");background-repeat:no-repeat;background-position:right 12px center;background-size:12px 12px;padding-right:36px}
select::-ms-expand{display:none}
.chips{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.chip{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #2a3654;background:#0b1324;border-radius:10px;font-size:14px;font-weight:600;color:#eef3ff}
.chip input[type="checkbox"]{accent-color:#4da3ff;inline-size:1.1rem;block-size:1.1rem;margin:0}
.small{font-size:12px;opacity:.8}

/* Content */
.cols{display:grid;grid-template-columns:repeat(4, minmax(220px, 1fr));gap:var(--gap)}
@media (max-width:1200px){.cols{grid-template-columns:repeat(3, minmax(220px, 1fr))}}
@media (max-width:900px){.cols{grid-template-columns:repeat(2, minmax(220px, 1fr))}}
@media (max-width:600px){.cols{grid-template-columns:1fr}}
.col{display:flex;flex-direction:column;gap:var(--gap)}
.col h3{margin:0 0 6px;font-size:14px;font-weight:700;opacity:.9}

/* Cards */
.card{background:#0f1525;border:1px solid #1f2a44;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;transition:box-shadow .15s ease}
.card:hover{ box-shadow:0 10px 24px rgba(0,0,0,.35) }
.thumbbox{position:relative;width:100%;aspect-ratio:16/9;background:#121826;display:flex;align-items:center;justify-content:center;overflow:hidden;border-bottom:1px solid #1f2a44}
.thumb{width:100%;height:100%;object-fit:contain;display:block;transition:transform .15s ease}
.thumbbox:hover .thumb{transform:scale(1.04)}
.meta{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.meta .left{display:flex;flex-direction:column}
.country{font-weight:700;font-size:14px}
.type,.date{opacity:.9;font-size:12px}
.footer{padding:10px 14px;border-top:1px solid #1f2a44;display:flex;align-items:center;gap:10px}
.btn{cursor:pointer;border:1px solid #2a385d;background:#101a33;padding:8px 10px;border-radius:10px;text-decoration:none;color:#e9eef2}
.filename{min-width:0;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;opacity:.95;font-size:12px;border:1px solid #2b364f;border-radius:8px;padding:4px 8px;background:#0f1525}
.badge{padding:2px 8px;border:1px solid #2b364f;border-radius:999px;background:#0f1525;font-size:12px}
.empty{opacity:.7;text-align:center;padding:40px}

/* Lightbox */
dialog#lightbox{border:none;padding:0;background:rgba(0,0,0,.6)}
dialog#lightbox::backdrop{background:rgba(0,0,0,.6)}
.lb{position:relative;display:flex;align-items:center;justify-content:center;width:100vw;height:100vh;max-width:100vw;max-height:100vh;margin:0;padding:8px}
.lb img{width:auto;height:auto;max-width:min(96vw,1600px);max-height:92vh;object-fit:contain;display:block;border-radius:10px;background:#0b0c10}
.btn.x{position:absolute;top:8px;right:8px;width:auto;z-index:2}

/* NEW: Pager row */
.pager{display:flex;justify-content:center;margin-top:18px}
 @media (max-width: 880px) {
    .side {
    position: static; /* Sticky ausschalten */
    top: auto;
  }
}

/* Tabs UI */
.tabs{max-width:var(--maxw);margin:8px auto 0;padding:0 10px;display:flex;gap:10px;flex-wrap:wrap}
.tablink{padding:8px 12px;border:1px solid #1f2a44;border-radius:10px;background:#101a33;color:#e9eef2;text-decoration:none}
.tablink.active{background:#e9eef2;color:#0b0c10}
.tab{display:none}
.tab.active{display:block}
/* Thresholds table tweaks */
#tab-thresholds table { width:100%; border-collapse: collapse; }
#tab-thresholds th, #tab-thresholds td { padding: 10px 12px; border-bottom: 1px solid #1f2a44; }
#tab-thresholds thead th { font-weight: 700; letter-spacing: 0.02em; }
#tab-thresholds th.sortable { cursor: pointer; position: relative; user-select: none; }
#tab-thresholds th.sortable::after { content: " ↕"; opacity: 0.6; font-size: 0.9em; }
#tab-thresholds th.sortable.asc::after { content: " ↑"; }
#tab-thresholds th.sortable.desc::after { content: " ↓"; }
#tab-thresholds td.num, #tab-thresholds th.num { width: 56px; text-align: right; color: #9fb3d1; }

</style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>BEV Trajectories • Gallery</h1>
      <div id="stats" class="small"></div>
    </div>
  </header>

  <nav class="tabs">
    <a href="#gallery" class="tablink active">Galerie</a>
    <a href="#thresholds" class="tablink">Thresholds</a>
    <a href="#durations" class="tablink">Durations</a>
  </nav>
<section id="tab-gallery" class="tab active">


  <div class="page">
    <aside class="side">
      <h2>Filters</h2>
      <label class="small">Country</label>
      <select id="countrySelect"><option value="">All countries</option></select>

      <div style="height:10px"></div>
      <label class="small">Types</label>
      <div class="chips">
        <label class="chip"><input type="checkbox" value="share" checked/> BEV trajectory</label>
        <label class="chip"><input type="checkbox" value="ICE_BEV" checked/> ICE↔BEV trajectory</label>
        <label class="chip"><input type="checkbox" value="ttm_shares" checked/> TTM market split</label>
        <label class="chip"><input type="checkbox" value="time" checked/> Transition time curves</label>
        <label class="chip"><input type="checkbox" id="latestOnly" checked/> Latest only</label>
      </div>

      <div style="height:10px"></div>
      <label class="small">Month</label>
      <select id="periodSelect" hidden><option value="">All months</option></select>

      <div style="height:10px"></div>
      <label class="small">Search</label>
      <input id="search" placeholder="Search (country, type, filename)" />

      <!-- NEW: Sorting UI -->
      <div style="height:14px"></div>
      <h2>Sort</h2>
      <label class="small">Field</label>
      <select id="sortField">
        <option value="created" selected>Created time (from filename)</option>
        <option value="country">Country</option>
        <option value="filename">Filename</option>
      </select>
      <div style="height:8px"></div>
      <label class="small">Direction</label>
      <select id="sortDir">
        <option value="desc" selected>Descending</option>
        <option value="asc">Ascending</option>
      </select>
      <!-- /NEW -->
    </aside>

    <main>
      <div id="cols" class="cols"></div>
      <div id="empty" class="empty" hidden>No matches. Relax filters.</div>
      <!-- NEW: Pager -->
      <div id="pager" class="pager" hidden>
        <button id="loadMore" class="btn">Load more</button>
      </div>
      <!-- /NEW -->
    </main>
  </div>

  <dialog id="lightbox"><div class="lb"><button class="btn x" onclick="lb.close()">Close</button><img alt=""/></div></dialog>
</section>



<section id="tab-thresholds" class="tab">
  <div style="max-width:var(--maxw);margin:14px auto;padding:0 10px">
    <h2 style="margin:0 0 12px;font-size:16px">Thresholds (Test)</h2>
    <div id="thresholdsMount" class="empty" style="padding:16px;border:1px dashed #2a3654;border-radius:10px;background:#0f1525">
      Lädt params.csv und berechnet 20/50/80 live im Browser.
    </div>
  </div>
</section>

<section id="tab-durations" class="tab">
  <div style="max-width:var(--maxw);margin:14px auto;padding:0 10px">
    <h2 style="margin:0 0 12px;font-size:16px">Durations</h2>
    <div id="durationsMount" class="empty" style="padding:16px;border:1px dashed #2a3654;border-radius:10px;background:#0f1525">
      Platzhalter – folgt nach Thresholds.
    </div>
  </div>
</section>

<script>

// ---- Tabs: robust hash routing + click intercept ----
function activateTabByHash(){
  const hash = location.hash || '#gallery';
  const id = hash.replace('#','');
  const tabs = document.querySelectorAll('.tab');
  const links = document.querySelectorAll('.tablink');
  tabs.forEach(el => { el.classList.remove('active'); el.setAttribute('hidden',''); });
  links.forEach(a => a.classList.remove('active'));
  const tab = document.getElementById('tab-' + id) || document.getElementById('tab-gallery');
  const link = document.querySelector('.tablink[href="#' + id + '"]') || document.querySelector('.tablink[href="#gallery"]');
  if (tab) { tab.classList.add('active'); tab.removeAttribute('hidden'); }
  if (link) link.classList.add('active');
}
window.addEventListener('hashchange', activateTabByHash);
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.tablink').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const href = a.getAttribute('href') || '#gallery';
      history.replaceState(null, '', href);
      activateTabByHash();
    });
  });
  activateTabByHash();
});

// ---- CSV Parser (',' oder ';') ----
function parseCSV(text) {
  const raw = (text || '').trim();
  if (!raw) return [];
  const first = raw.split(/\r?\n/)[0] || '';
  const delimiter = (first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length ? ';' : ',';
  const lines = raw.split(/\r?\n/);
  const header = (lines.shift() || '').split(delimiter).map(h => h.replace(/^\uFEFF?/,'').trim());
  return lines.filter(Boolean).map(line => {
    const cols = line.split(new RegExp(`${delimiter}(?=(?:[^"]*"[^"]*")*[^"]*$)`));
    const o = {};
    header.forEach((h,i)=> o[h] = (cols[i]||'').replace(/^\"|\"$/g,'').trim());
    return o;
  });
}

// ---- Inversion: y = 1 - exp( v1 * (x - (t0 - 1))^v2 )
function x_for_threshold(y, v1, v2, t0) {
  if (!(y > 0 && y < 1)) return NaN;
  const v1n = Number(v1), v2n = Number(v2), t0n = Number(t0);
  if (!isFinite(v1n) || !isFinite(v2n) || !isFinite(t0n) || v2n === 0) return NaN;
  const num = Math.log(1 - y) / v1n; // v1 < 0 erwartet
  if (!(num > 0)) return NaN;
  return (t0n - 1) + Math.pow(num, 1 / v2n);
}
function monthsIndexToDate(x, baselineISO) {
  if (!baselineISO) return '';
  const base = new Date(baselineISO + 'T00:00:00Z');
  if (isNaN(base.getTime()) || !isFinite(x)) return '';
  const shift = x - 1, whole = Math.floor(shift), frac = shift - whole;
  const d = new Date(Date.UTC(base.getUTCFullYear(), base.getUTCMonth() + whole, 1));
  d.setUTCDate(15); d.setUTCDate(d.getUTCDate() + Math.round(frac * 30));
  return d.toISOString().slice(0,10);
}

// ---- Thresholds with sorting & row numbers ----
function renderThresholdsMinimal(csvText){
  const rows = parseCSV(csvText);
  const mount = document.getElementById('thresholdsMount');
  if (!rows.length) { mount.textContent = 'params.csv enthält keine Datenzeilen.'; return; }

  let data = rows.map(r => {
    const v1 = Number(r.v1), v2 = Number(r.v2), t0 = Number(r.t0);
    const base = r.baseline_date || '';
    const x20 = x_for_threshold(0.2, v1, v2, t0);
    const x50 = x_for_threshold(0.5, v1, v2, t0);
    const x80 = x_for_threshold(0.8, v1, v2, t0);
    const f = (x) => base ? monthsIndexToDate(x, base) : (isFinite(x) ? x.toFixed(2) : '');
    return {
      country: r.country || '',
      variant: r.variant || '',
      val20: f(x20), val50: f(x50), val80: f(x80),
      model_date: r.model_date || '',
      source: r.source || ''
    };
  });

  function isoOrVal(s) {
    const t = Date.parse(s);
    if (!isNaN(t)) return t;
    const n = parseFloat(s);
    return isFinite(n) ? n : (s||'').toString().toLowerCase();
  }
  let sortKey = null, sortAsc = true;
  function doSort() {
    if (!sortKey) return;
    data.sort((a,b) => {
      const va = isoOrVal(a[sortKey]); const vb = isoOrVal(b[sortKey]);
      if (va < vb) return sortAsc ? -1 : 1;
      if (va > vb) return sortAsc ? 1 : -1;
      return 0;
    });
  }
  function renderTable() {
    doSort();
    const header = `
      <thead>
        <tr>
          <th class="num">#</th>
          <th class="sortable" data-key="country">Land</th>
          <th class="sortable" data-key="variant">Variante</th>
          <th class="sortable" data-key="val20">20%</th>
          <th class="sortable" data-key="val50">50%</th>
          <th class="sortable" data-key="val80">80%</th>
          <th class="sortable" data-key="model_date">Modelldatum</th>
          <th>Quelle</th>
        </tr>
      </thead>`;
    const body = `<tbody>
      ${data.map((r,i)=>`
        <tr>
          <td class="num">${i+1}</td>
          <td>${r.country}</td>
          <td>${r.variant}</td>
          <td>${r.val20}</td>
          <td>${r.val50}</td>
          <td>${r.val80}</td>
          <td>${r.model_date}</td>
          <td>${r.source}</td>
        </tr>`).join('')}
    </tbody>`;
    mount.innerHTML = `<table class="table">${header}${body}</table>`;
    const ths = mount.querySelectorAll('th.sortable');
    ths.forEach(th => {
      th.classList.remove('asc','desc');
      if (th.getAttribute('data-key') === sortKey) th.classList.add(sortAsc ? 'asc' : 'desc');
      th.onclick = () => {
        const key = th.getAttribute('data-key');
        if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
        renderTable();
      };
    });
  }
  renderTable();
}

// Boot for thresholds
function bootThresholds(){
  const urls = ['./params.csv','params.csv'];
  (function next(i){
    if (i>=urls.length) { const m=document.getElementById('thresholdsMount'); if(m) m.textContent='Konnte params.csv nicht laden.'; return; }
    fetch(urls[i], { cache:'no-store' })
      .then(r => r.ok ? r.text() : Promise.reject(new Error('HTTP '+r.status)))
      .then(text => renderThresholdsMinimal(text))
      .catch(()=> next(i+1));
  })(0);
}
document.addEventListener('DOMContentLoaded', bootThresholds);

const cols = document.getElementById('cols');
const empty = document.getElementById('empty');
const lb = document.getElementById('lightbox');
const lbImg = lb.querySelector('img');
const countrySelect = document.getElementById('countrySelect');
const periodSelect  = document.getElementById('periodSelect');
const searchInput   = document.getElementById('search');
const stats = document.getElementById('stats');
const latestOnly   = document.getElementById('latestOnly');
const typeChecks   = [...document.querySelectorAll('.chip input[type="checkbox"][value]')];

// NEW: sorting + paging
const sortField = document.getElementById('sortField');
const sortDir   = document.getElementById('sortDir');
const pager     = document.getElementById('pager');
const loadMoreBtn = document.getElementById('loadMore');
const INITIAL_ROWS = 3;        // wie viele Zeilen pro Spalte initial
const PAGE_ROWS    = 3;        // wie viele Zeilen "Load more" zusätzlich zeigt
let visibleRows    = INITIAL_ROWS;
// /NEW

const TYPE_LABEL = {
  share: 'BEV trajectory',
  ICE_BEV: 'ICE↔BEV trajectory',
  ttm_shares: 'TTM market split graph',
  time: 'Transition time curve'
};
const TYPE_ORDER = ['share','ICE_BEV','ttm_shares','time'];

function prettyPeriod(p){
  if(!/^\d{4}-\d{2}$/.test(p)) return p;
  const [y,m] = p.split('-').map(Number);
  return new Date(y, m-1, 1).toLocaleDateString('en-US', {month:'short', year:'numeric'});
}
async function loadManifest(){
  const res = await fetch('manifest.json', {cache:'no-store'});
  return res.json();
}
const uniq = xs => [...new Set(xs)];

// unverändert: nimmt das jüngste period je country+type
function latestByKey(items){
  const map = new Map();
  const toNum = p => Number((p||"0000-00").replace("-",""));
  for(const it of items){
    const k = `${it.country}|||${it.type}`;
    const cur = map.get(k);
    if(!cur || toNum(it.period) > toNum(cur.period)) map.set(k, it);
  }
  return [...map.values()];
}

// NEW: Created-Time (aus Dateiname) extrahieren, z.B. germany_ICE_BEV_20250704.png
function createdNum(it){
  const m = it.filename && it.filename.match(/(\d{8})(?=\.[^.]+$)/);
  return m ? Number(m[1]) : 0;
}
function compareItems(a,b,field,dir){
  const sgn = dir === 'asc' ? 1 : -1;
  if(field === 'created'){
    const da = createdNum(a), db = createdNum(b);
    if(da === db) return sgn * a.filename.localeCompare(b.filename);
    return sgn * (da - db);
  }
  if(field === 'country'){
    return sgn * a.country.localeCompare(b.country);
  }
  if(field === 'filename'){
    return sgn * a.filename.localeCompare(b.filename);
  }
  return 0;
}
// /NEW

function renderColumns(items){
  cols.innerHTML = '';
  if(items.length === 0){ 
    empty.hidden = false; 
    stats.textContent = ''; 
    pager.hidden = true;
    return; 
  }
  empty.hidden = true;

  // NEW: sortiere VOR Aufteilung nach Typ
  const field = sortField.value;
  const dir   = sortDir.value;
  const sorted = [...items].sort((a,b)=>compareItems(a,b,field,dir));
  // /NEW

  const byType = Object.fromEntries(TYPE_ORDER.map(t=>[t, []]));
  for(const it of sorted){ if(byType[it.type]) byType[it.type].push(it); }

  let visibleCount = 0;
  let totalCount = 0;
  let canLoadMore = false;

  for(const t of TYPE_ORDER){
    const list = byType[t];
    if(!list || list.length === 0) continue;
    const col = document.createElement('section');
    col.className = 'col';
    const h = document.createElement('h3'); h.textContent = TYPE_LABEL[t]; col.append(h);

    const take = Math.min(list.length, visibleRows);
    totalCount += list.length;
    visibleCount += take;
    if(list.length > visibleRows) canLoadMore = true;

    for(let i=0;i<take;i++){
      const it = list[i];
      const card = document.createElement('article'); card.className = 'card';
      const box = document.createElement('div'); box.className = 'thumbbox';
      const img = document.createElement('img'); img.className = 'thumb'; img.loading='lazy'; img.decoding='async'; img.src = it.url; img.alt = it.alt || `${it.country} – ${it.type}`;
      img.addEventListener('click', ()=>{ lbImg.src = it.url; lbImg.alt = img.alt; lb.showModal(); });
      box.append(img);

      const meta = document.createElement('div'); meta.className = 'meta';
      const right = [it.period || '', it.date || ''].filter(Boolean).join(' • ');
      meta.innerHTML = `<div class="left"><div class="country">${it.country}</div><div class="type">${TYPE_LABEL[it.type] || it.type}</div></div><div class="date">${right}</div>`;

      const footer = document.createElement('div'); footer.className = 'footer';
      footer.innerHTML = `<a class="btn" href="${it.url}" download>Download</a><span class="filename">${it.filename}</span>`;

      card.append(box, meta, footer);
      col.append(card);
    }
    cols.append(col);
  }

  // NEW: Stats & Pager
  stats.innerHTML = `<span class="badge">Showing ${visibleCount} of ${totalCount} charts</span>`;
  pager.hidden = !canLoadMore;
  // /NEW
}

function applyFilters(all){
  const q = searchInput.value.trim().toLowerCase();
  const allowedTypes = new Set(typeChecks.filter(c=>c.checked).map(c=>c.value));
  const country = countrySelect.value;
  const period  = periodSelect.value;

  let out = all.filter(it=>{
    if(country && it.country !== country) return false;
    if(!allowedTypes.has(it.type)) return false;
    if(period && it.period !== period) return false;
    const hay = `${it.country} ${it.type} ${it.date} ${it.period} ${it.filename}`.toLowerCase();
    return q === '' || hay.includes(q);
  });
  if(latestOnly && latestOnly.checked && !period) out = latestByKey(out);
  return out;
}

loadManifest().then(({images})=>{
  // Filters
  const countries = uniq(images.map(x=>x.country)).sort();
  countries.forEach(c=>{
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; countrySelect.append(opt);
  });
  const periods = uniq(images.map(x=>x.period).filter(Boolean)).sort();
  if(periods.length){ periodSelect.hidden = false; periods.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=prettyPeriod(p); periodSelect.append(o); }); }

  const update=()=>{ 
    const list = applyFilters(images); 
    renderColumns(list); 
  };

  const resetAndUpdate=()=>{ visibleRows = INITIAL_ROWS; update(); }; // NEW

  countrySelect.addEventListener('change', resetAndUpdate);
  periodSelect.addEventListener('change', resetAndUpdate);
  typeChecks.forEach(c=>c.addEventListener('change', resetAndUpdate));
  latestOnly.addEventListener('change', resetAndUpdate);
  searchInput.addEventListener('input', resetAndUpdate);

  // NEW: sort + pager events
  sortField.addEventListener('change', resetAndUpdate);
  sortDir.addEventListener('change', resetAndUpdate);
  loadMoreBtn.addEventListener('click', ()=>{ visibleRows += PAGE_ROWS; update(); });
  // /NEW

  // Default: Created time desc
  sortField.value = 'created';
  sortDir.value = 'desc';

  update();
});

lb.addEventListener('click', (e) => { if (e.target === lb) lb.close(); });
</script>
</body>
</html>
