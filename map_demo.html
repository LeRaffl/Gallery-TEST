<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BEV • Transition Map (Demo)</title>
<style>
  :root { --bg:#0b0c10; --fg:#e9eef2; --muted:#7f8a9a; --panel:#111624; --border:#1c2333; }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#0f1117cc;backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border)}
  header .bar{max-width:1280px;margin:0 auto;padding:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{margin:0 10px 0 0;font-size:18px}
  select, label, input{font-size:14px}
  main{max-width:1280px;margin:0 auto;padding:12px}
  .wrap{display:grid;grid-template-columns:1fr 280px;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:10px}
  #map{aspect-ratio:16/9;width:100%}
  .panel{padding:12px}
  .legend{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:6px}
  .swatch{width:16px;height:16px;border-radius:3px;border:1px solid #0002}
  .tooltip{position:fixed;pointer-events:none;z-index:10;background:#101521; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:13px}
  .nodata{fill:url(#hatch);fill-opacity:1}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .note{font-size:12px;color:var(--muted)}
  a{color:#9ad0ff;text-decoration:none}
</style>
</head>
<body>
<header><div class="bar">
  <h1>BEV Transition Map • Demo</h1>
  <div class="row">
    <label>Region
      <select id="regionSel">
        <option value="world" selected>Welt</option>
        <option value="europe">Europa</option>
      </select>
    </label>
    <label>Variant
      <select id="variantSel">
        <option value="whole">Whole</option>
        <option value="private">Private</option>
        <option value="industry">Industry</option>
        <option value="2w">2-Wheelers</option>
        <option value="3w">3-Wheelers</option>
        <option value="4w">4-Wheelers</option>
      </select>
    </label>
    <span class="row" id="metrics">
      <label><input type="radio" name="metric" value="dur2080" checked> 20→80 Dauer</label>
      <label><input type="radio" name="metric" value="y20"> 20%-Jahr</label>
      <label><input type="radio" name="metric" value="y80"> 80%-Jahr</label>
      <label><input type="radio" name="metric" value="speed_inflect"> Speed</label>
    </span>
  </div>
</div></header>

<main class="wrap">
  <div class="card"><svg id="map"></svg></div>
  <div class="card panel">
    <div><strong>Legende</strong><div id="legend" class="legend"></div></div>
    <hr style="border-color:var(--border)">
    <div id="side" class="muted">Fahre über ein Land…</div>
    <hr style="border-color:var(--border)">
    <div class="note">Grau schraffiert = keine Daten. Rosa = no transition. „Special“ = manuell gesetzte Farbe (z. B. NOR).</div>
  </div>
</main>

<div id="tt" class="tooltip" style="opacity:0"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script>
const files = {
  world:  "data/world.topo.json",   // Stelle hier dein Topo mit id=ISO3 hin
  europe: "data/europe.topo.json",
  metrics:"data/map_metrics.csv"
};

const COLORS = {
  noTrans: "#f4a3ff",
  missing: "url(#hatch)"
};

const svg = d3.select("#map");
const g = svg.append("g");
const path = d3.geoPath();
const defs = svg.append("defs");
const pat = defs.append("pattern").attr("id","hatch").attr("patternUnits","userSpaceOnUse")
  .attr("width",6).attr("height",6).append("path")
  .attr("d","M0,0 l6,6 M-1,1 l2,2 M5,-1 l2,2")
  .attr("stroke","#6b7280").attr("stroke-width",1);

let metricsData = [], topoCache = {};
const state = { region: "world", variant: "whole", metric: "dur2080" };

init();

async function init(){
  metricsData = await d3.csv(files.metrics, d => ({
    iso3: d.iso3, country:d.country, variant:d.variant,
    y20: +d.y20, y50:+d.y50, y80:+d.y80, dur2080:+d.dur2080, speed_inflect:+d.speed_inflect,
    last_update:d.last_update, qual:d.data_quality || "ok",
    status:(d.status||"").toLowerCase(), special_hex:d.special_hex||""
  }));
  await ensureTopo("world");
  await ensureTopo("europe");
  bindControls();
  draw();
}

function bindControls(){
  d3.select("#regionSel").on("change", e => { state.region = e.target.value; draw(); });
  d3.select("#variantSel").on("change", e => { state.variant = e.target.value; draw(); });
  d3.selectAll('input[name="metric"]').on("change", e => { state.metric = e.target.value; draw(); });
}

async function ensureTopo(key){
  if (topoCache[key]) return;
  const tj = await d3.json(files[key]);
  const feats = topojson.feature(tj, tj.objects[Object.keys(tj.objects)[0]]);
  topoCache[key] = feats;
}

function draw(){
  const feats = topoCache[state.region];
  const {width, height} = fitSVG();
  const proj = d3.geoMercator().fitSize([width, height], feats);
  path.projection(proj);

  const rows = metricsData.filter(d => d.variant === state.variant);
  const byIso = new Map(rows.map(d => [d.iso3, d]));

  const values = feats.features.map(f => byIso.get(f.id)?.[state.metric]).filter(Number.isFinite);
  const domain = computeDomain(values, state.metric);
  const color = colorScale(domain, state.metric);

  g.selectAll("path.country").data(feats.features, d=>d.id).join("path")
    .attr("class","country")
    .attr("d", path)
    .attr("fill", d => {
      const row = byIso.get(d.id);
      if (!row) return COLORS.missing;
      if (row.status === "no_transition") return COLORS.noTrans;
      if (row.status === "special" && row.special_hex) return row.special_hex;
      const v = row[state.metric];
      if (!Number.isFinite(v)) return COLORS.missing;
      const [lo,hi] = domain;
      const vv = Math.max(Math.min(v, hi), lo);
      return color(vv);
    })
    .attr("stroke","#111821")
    .attr("stroke-width", d => {
      const row = byIso.get(d.id);
      if (!row) return 0.5;
      const v = row[state.metric];
      if (!Number.isFinite(v)) return 0.5;
      return (v < domain[0] || v > domain[1]) ? 1.8 : 0.5;
    })
    .on("mousemove", (ev,d) => showTooltip(ev,d,byIso))
    .on("mouseleave", hideTooltip)
    .on("click", (ev,d) => pinnedSide(d,byIso,domain,color));

  drawLegend(color, domain, state.metric);
}

function fitSVG(){
  const bbox = svg.node().getBoundingClientRect();
  const w = bbox.width || 900, h = Math.max(360, w*9/16);
  svg.attr("width", w).attr("height", h);
  return {width:w, height:h};
}

function computeDomain(values, metric){
  const v = values.slice().sort((a,b)=>a-b);
  if (!v.length) return [0,1];
  if (metric === "dur2080" || metric === "speed_inflect") {
    const lo = quantile(v, 0.05), hi = quantile(v, 0.95);
    return [lo, hi];
  } else {
    const lo = Math.floor(Math.min(...v));
    const hi = Math.ceil(Math.max(...v));
    return [lo, hi];
  }
}

function colorScale([lo,hi], metric){
  if (metric === "dur2080") {
    return d3.scaleSequential().domain([hi, lo]).interpolator(d3.interpolateTurbo);
  } else if (metric === "speed_inflect") {
    return d3.scaleSequential().domain([lo, hi]).interpolator(d3.interpolatePlasma);
  } else {
    return d3.scaleSequential().domain([lo, hi]).interpolator(d3.interpolateViridis);
  }
}

function drawLegend(scale, [lo,hi], metric){
  const steps = 6;
  const L = d3.range(steps).map(i => d3.interpolateNumber(lo,hi)(i/(steps-1)));
  const fmt = (x)=> metric.startsWith("y") ? Math.round(x) : niceNum(x);
  const unit = metric==="dur2080" ? "Jahre" : (metric==="speed_inflect" ? "Speed" : "");

  const box = d3.select("#legend").html("");
  L.forEach(v=>{
    const sw = document.createElement("div");
    sw.className="swatch"; sw.style.background = scale(v);
    box.node().appendChild(sw);
  });
  const labels = document.createElement("div");
  labels.style.width="100%"; labels.style.display="flex"; labels.style.justifyContent="space-between";
  labels.innerHTML = `<span>${fmt(lo)}</span><span class="muted">${unit}</span><span>${fmt(hi)}</span>`;
  box.node().appendChild(labels);

  const extra = document.createElement("div");
  extra.style.marginTop = "6px";
  extra.innerHTML = `<span class="swatch" style="background:${COLORS.noTrans}"></span> no transition`;
  box.node().appendChild(extra);
}

function showTooltip(ev, feat, byIso){
  const row = byIso.get(feat.id);
  const tt = d3.select("#tt");
  if (!row){ hideTooltip(); return; }
  const html = `
    <div><strong>${row.country}</strong> <span class="muted">(${feat.id})</span></div>
    <div class="muted">Variant: ${row.variant} • Status: ${row.status||"ok"}</div>
    ${row.status==="no_transition" ? "<em>No noteworthy transition</em>" : `
    <div>20→80 Dauer: <strong>${printVal(row.dur2080,"J")}</strong></div>
    <div>20%-Jahr: <strong>${printVal(row.y20,"")}</strong> • 80%-Jahr: <strong>${printVal(row.y80,"")}</strong></div>
    <div>Speed: <strong>${printVal(row.speed_inflect,"")}</strong></div>`}
  `;
  tt.html(html).style("opacity",1)
    .style("left",(ev.clientX+12)+"px")
    .style("top",(ev.clientY+12)+"px");
}
function hideTooltip(){ d3.select("#tt").style("opacity",0); }

function pinnedSide(feat, byIso){
  const row = byIso.get(feat.id);
  if (!row){ d3.select("#side").text("Keine Daten."); return; }
  d3.select("#side").html(`
    <div><strong>${row.country}</strong> <span class="muted">(${feat.id})</span></div>
    <div class="muted">Variant: ${row.variant}; Update: ${row.last_update||"—"}</div>
    ${row.status==="no_transition" ? "<p><em>No noteworthy transition</em></p>" : `
    <ul>
      <li>20→80 Dauer: <strong>${printVal(row.dur2080,"J")}</strong></li>
      <li>20%-Jahr: <strong>${printVal(row.y20,"")}</strong></li>
      <li>80%-Jahr: <strong>${printVal(row.y80,"")}</strong></li>
      <li>Speed (Wendetangente): <strong>${printVal(row.speed_inflect,"")}</strong></li>
    </ul>`}
  `);
}

function quantile(a, p){
  const i = (a.length-1)*p, i0 = Math.floor(i), i1 = Math.ceil(i);
  if (i0===i1) return a[i0];
  return a[i0] + (a[i1]-a[i0])*(i - i0);
}
function niceNum(x){ return Number.isFinite(x) ? (Math.round(x*10)/10) : "—"; }
function printVal(v, suf){ return Number.isFinite(v) ? `${niceNum(v)}${suf}` : "—"; }
</script>
</body>
</html>
